<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Multi-Sender Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* CSS ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô Schedule */
        .schedule-section { background: #f0f7ff; border: 1px dashed #3b82f6; }
        .dashboard { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .schedule-item { 
            background: #fff; border: 1px solid #ddd; padding: 10px; 
            border-radius: 10px; margin-bottom: 10px; font-size: 0.85rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .status-badge { background: #3b82f6; color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.7rem; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üü¢ LINE Sender Pro</h1>

        <div class="token-manager">
            <div class="grid-config">
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</label>
                    <select id="tokenSelect" onchange="loadSelectedToken()">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢)</label>
                    <input type="text" id="tokenName" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">
                </div>
            </div>
            <div class="form-group">
                <label>Channel Access Token</label>
                <input type="password" id="token" placeholder="‡∏ß‡∏≤‡∏á Access Token">
            </div>
            <button class="btn-save" onclick="saveToken()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Token ‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
            <button class="btn-save" style="background:#e0e02e" onclick="clearTokens()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div class="token-manager schedule-section">
            <label style="color: #1e40af; font-weight: bold;">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)</label>
            <input type="datetime-local" id="scheduleTime" style="margin-top: 5px;">
            <p style="font-size: 0.75rem; color: #64748b; margin-top: 5px;">* ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
        </div>

        <div class="form-group">
            <label>User IDs ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ 1 ID)</label>
            <textarea id="userIds" rows="5" placeholder="U123..."></textarea>
        </div>

        <div id="message-area">
            <script>
                for(let i=1; i<=5; i++) {
                    document.write(`
                        <div class="message-box">
                            <div class="box-header">
                                <span style="font-weight:500; color:#64748b">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà ${i}</span>
                                <select id="type-${i}" style="width:auto; padding:4px">
                                    <option value="text">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</option>
                                    <option value="image">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)</option>
                                </select>
                            </div>
                            <textarea id="val-${i}" rows="2" placeholder="‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠ Link ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û..."></textarea>
                        </div>
                    `);
                }
            </script>
        </div>

        <button onclick="processAndSend()" id="sendBtn" class="btn-send">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>

        <div class="dashboard">
            <h3 style="font-size: 1rem; margin-bottom: 15px;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ß‡πâ (‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ)</h3>
            <div id="scheduleList">
                <p style="text-align: center; color: #94a3b8; font-size: 0.9rem;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤</p>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwJL6cgF1EDgdsd6NOZKu5FIBXK6figp8OS6r_gFDRxsxhFHwzu3m4aFo4Gjwl4CFds/exec";

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Token ---
        let savedTokens = JSON.parse(localStorage.getItem('vafper_tokens') || '{}');
        let scheduledTasks = JSON.parse(localStorage.getItem('vafper_schedules') || '[]');

        function updateDropdown() {
            const select = document.getElementById('tokenSelect');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ --</option>';
            for (let name in savedTokens) {
                let opt = document.createElement('option');
                opt.value = name;
                opt.innerHTML = name;
                select.appendChild(opt);
            }
        }

        function saveToken() {
            const name = document.getElementById('tokenName').value;
            const token = document.getElementById('token').value;
            if(!name || !token) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ Token ‡∏Ñ‡∏£‡∏±‡∏ö");
            
            savedTokens[name] = token;
            localStorage.setItem('vafper_tokens', JSON.stringify(savedTokens));
            updateDropdown();
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        }

        function loadSelectedToken() {
            const name = document.getElementById('tokenSelect').value;
            if(name) {
                document.getElementById('tokenName').value = name;
                document.getElementById('token').value = savedTokens[name];
            }
        }

        function clearTokens() {
            if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
                localStorage.removeItem('vafper_tokens');
                savedTokens = {};
                updateDropdown();
                document.getElementById('token').value = "";
                document.getElementById('tokenName').value = "";
            }
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö Dashboard (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô 24 ‡∏ä‡∏°.) ---
        function updateScheduleList() {
            const listDiv = document.getElementById('scheduleList');
            const now = new Date().getTime();
            const ONE_DAY_MS = 24 * 60 * 60 * 1000;
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
            const beforeLength = scheduledTasks.length;
            scheduledTasks = scheduledTasks.filter(task => {
                const taskTime = new Date(task.time).getTime();
                return (now - taskTime) < ONE_DAY_MS;
            });

            if (scheduledTasks.length !== beforeLength) {
                localStorage.setItem('vafper_schedules', JSON.stringify(scheduledTasks));
            }

            if (scheduledTasks.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #94a3b8; font-size: 0.9rem;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤</p>';
                return;
            }

            listDiv.innerHTML = scheduledTasks.map((task, index) => {
                const taskTime = new Date(task.time).getTime();
                const isSent = now >= taskTime;
                
                return `
                    <div class="schedule-item" style="${isSent ? 'border-color: #06C755; background: #f0fff4;' : ''}">
                        <div>
                            <div style="font-weight: 500;">üîî ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ ${task.count} IDs (${task.name})</div>
                            <div style="font-size: 0.75rem; color: #64748b;">‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î: ${new Date(task.time).toLocaleString('th-TH')}</div>
                        </div>
                        <div style="text-align: right;">
                            ${isSent 
                                ? '<span class="status-badge" style="background: #06C755; color: white;">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>' 
                                : '<span class="status-badge">‡∏£‡∏≠‡∏™‡πà‡∏á</span>'
                            }
                            <button onclick="deleteSchedule(${index})" style="background:none; border:none; color:red; cursor:pointer; margin-left:10px;">‚úï</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        setInterval(updateScheduleList, 60000);

        function deleteSchedule(index) {
            if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô?")) {
                scheduledTasks.splice(index, 1);
                localStorage.setItem('vafper_schedules', JSON.stringify(scheduledTasks));
                updateScheduleList();
            }
        }

        async function processAndSend() {
            const btn = document.getElementById('sendBtn');
            const token = document.getElementById('token').value;
            const userIdsRaw = document.getElementById('userIds').value.trim();
            const scheduleTime = document.getElementById('scheduleTime').value;
            
            if(!token || !userIdsRaw) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡∏ß‡πä‡∏≤‡∏ü!");

            const userIds = userIdsRaw.split('\n').map(id => id.trim()).filter(id => id !== "");
            let messages = [];

            for(let i=1; i<=5; i++) {
                const type = document.getElementById(`type-${i}`).value;
                const val = document.getElementById(`val-${i}`).value.trim();
                if(val) {
                    if(type === 'text') {
                        messages.push({ type: "text", text: val });
                    } else {
                        messages.push({ type: "image", originalContentUrl: val, previewImageUrl: val });
                    }
                }
            }

            if(messages.length === 0) return alert("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏∞");

            btn.disabled = true;
            btn.innerText = scheduleTime ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤..." : "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ 
                        token, 
                        userIds, 
                        messages,
                        scheduleTime: scheduleTime || null 
                    })
                });

                if (scheduleTime) {
                    scheduledTasks.push({
                        time: scheduleTime,
                        count: userIds.length,
                        name: document.getElementById('tokenName').value || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'
                    });
                    localStorage.setItem('vafper_schedules', JSON.stringify(scheduledTasks));
                    updateScheduleList();
                    alert("‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!");
                } else {
                    alert("‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô LINE ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
                }

            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err);
            } finally {
                btn.disabled = false;
                btn.innerText = "‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°";
                document.getElementById('scheduleTime').value = "";
            }
        }

        updateDropdown();
        updateScheduleList();
    </script>
</body>
</html>