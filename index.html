<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Multi-Sender Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <h1>üü¢ LINE Sender Pro</h1>

        <div class="token-manager">
            <div class="grid-config">
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</label>
                    <select id="tokenSelect" onchange="loadSelectedToken()">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢)</label>
                    <input type="text" id="tokenName" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">
                </div>
            </div>
            <div class="form-group">
                <label>Channel Access Token</label>
                <input type="password" id="token" placeholder="‡∏ß‡∏≤‡∏á Access Token">
            </div>
            <button class="btn-save" onclick="saveToken()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Token ‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
            <button class="btn-save" style="background:#ef4444" onclick="clearTokens()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div class="form-group">
            <label>User IDs ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ 1 ID)</label>
            <textarea id="userIds" rows="5" placeholder="U123..."></textarea>
        </div>

        <div id="message-area">
            <script>
                for(let i=1; i<=5; i++) {
                    document.write(`
                        <div class="message-box">
                            <div class="box-header">
                                <span style="font-weight:500; color:#64748b">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà ${i}</span>
                                <select id="type-${i}" style="width:auto; padding:4px">
                                    <option value="text">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</option>
                                    <option value="image">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)</option>
                                </select>
                            </div>
                            <textarea id="val-${i}" rows="2" placeholder="‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠ Link ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û..."></textarea>
                        </div>
                    `);
                }
            </script>
        </div>

        <button onclick="processAndSend()" id="sendBtn" class="btn-send">üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Multicast)</button>
    </div>

    <script>
        const GAS_URL = "‡∏ß‡∏≤‡∏á_URL_APPS_SCRIPT_‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà";

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Token ---
        let savedTokens = JSON.parse(localStorage.getItem('vafper_tokens') || '{}');

        function updateDropdown() {
            const select = document.getElementById('tokenSelect');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ --</option>';
            for (let name in savedTokens) {
                let opt = document.createElement('option');
                opt.value = name;
                opt.innerHTML = name;
                select.appendChild(opt);
            }
        }

        function saveToken() {
            const name = document.getElementById('tokenName').value;
            const token = document.getElementById('token').value;
            if(!name || !token) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ Token ‡∏Ñ‡∏£‡∏±‡∏ö");
            
            savedTokens[name] = token;
            localStorage.setItem('vafper_tokens', JSON.stringify(savedTokens));
            updateDropdown();
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        }

        function loadSelectedToken() {
            const name = document.getElementById('tokenSelect').value;
            if(name) {
                document.getElementById('tokenName').value = name;
                document.getElementById('token').value = savedTokens[name];
            }
        }

        function clearTokens() {
            if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
                localStorage.removeItem('vafper_tokens');
                savedTokens = {};
                updateDropdown();
                document.getElementById('token').value = "";
                document.getElementById('tokenName').value = "";
            }
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ---
        async function processAndSend() {
            const btn = document.getElementById('sendBtn');
            const token = document.getElementById('token').value;
            const userIdsRaw = document.getElementById('userIds').value.trim();
            
            if(!token || !userIdsRaw) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡∏ß‡πä‡∏≤‡∏ü!");

            const userIds = userIdsRaw.split('\n').map(id => id.trim()).filter(id => id !== "");
            let messages = [];

            for(let i=1; i<=5; i++) {
                const type = document.getElementById(`type-${i}`).value;
                const val = document.getElementById(`val-${i}`).value.trim();
                if(val) {
                    if(type === 'text') {
                        messages.push({ type: "text", text: val });
                    } else {
                        messages.push({ type: "image", originalContentUrl: val, previewImageUrl: val });
                    }
                }
            }

            if(messages.length === 0) return alert("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏∞");

            btn.disabled = true;
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ token, userIds, messages })
                });
                alert("‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô LINE ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err);
            } finally {
                btn.disabled = false;
                btn.innerText = "üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Multicast)";
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        updateDropdown();
    </script>
</body>
</html>